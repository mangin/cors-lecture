<!DOCTYPE HTML>
<html lang="en">
<head>
    <title>CORS</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=792, user-scalable=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <link rel="stylesheet" href="node_modules/shower-ribbon/styles/screen.css">
    <link rel="stylesheet" href="style.css">
</head>
<body class="list">
<header class="caption">
    <h1>CORS</h1>
</header>
<section class="slide cover" id="Cover">
    <div>
        <h2>CORS</h2>

        <p>Brought to you by <a href="http://pepelsbey.net">Mangin Alexander</a></p>
        <img src="pictures/cover.jpg" alt="">
        <!--
            To apply styles to the certain slides
            set slide ID to get needed elements
            -->
        <style>
            #Cover h2
            {
                margin: 30px 0 0;
                color: #FFF;
                text-align: center;
                font-size: 70px;
            }

            #Cover p
            {
                margin: 10px 0 0;
                text-align: center;
                color: #FFF;
                font-style: italic;
                font-size: 20px;
            }

            #Cover p a
            {
                color: #FFF;
            }
        </style>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Что будет рассказано на лекции</h2>
        <ol>
            <li>Что такое CORS?</li>
            <li>Зачем он нужен?</li>
            <li>Как его заставить работать в современных браузерах?</li>
            <li>Как его заставить работать в браузере-который-нельзя-называть</li>
        </ol>
    </div>
</section>

<section class="slide cover picture">
    <div>
        <img src="pictures/work-flow.jpg" alt="" width="1024px" height="640px">
    </div>
</section>

<section class="slide cover picture">
    <div>
        <img src="pictures/shov.jpg" alt="" width="1024px" height="640px">
    </div>
</section>

<section class="slide">
    <div>
        <h2>Что обычно выходит</h2>
        Большущий фронт
    </div>
</section>

<section class="slide">
    <div>
        <h2>Как поделиться функциональностью с другими сервисами?</h2>
        <ul>
            <li>Написать все по новой</li>
            <li>Выделить код в библиотеку и поделиться</li>
            <li>JSONP</li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <h2>JSONP = JSON with padding</h2>
        <ul>
            <li>Клиент генерит url к JSONP ручке /get/reports?func=showReports</li>
            <li>Вставляет в дом скрипт тэк скрипт с JSONP url</li>
            <li>
                Сервер возвращает скрипт вида:
                showReports([
                {},
                {}
                ]);
            </li>
            <li>Браузер выпоняет скрипт</li>
            <li>PROFIT!</li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <h2>JSONP ограничения</h2>
        <ol>
            <li>только get</li>
            <li>нужна глобальная функция для связи с ответом</li>
            <li>нельзя отправить дополнительные заголовки</li>
            <li>сложно обрабатывать ошибки</li>
        </ol>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Немного улучшений</h2>
        <ol>
            <li>pfr.kontur.ru</li>
            <li>kladr-api.kontur.ru</li>
            <li>check-pfr.kontur.ru</li>
            <li>cloud.kontur.ru</li>
            <li>...</li>
        </ol>
    </div>
</section>

<section class="slide cover picture">
    <div>
        <img src="pictures/kostil.jpg" alt="" width="1024px" height="640px">
        <style>
            .picture h2
            {
                color: #FFF;
            }
        </style>
    </div>
</section>

<section class="slide cover picture">
    <div>
        <img src="pictures/star-wars.png" alt="" width="1024px" height="640px">
        <style>
            .picture h2
            {
                color: #FFF;
            }
        </style>
    </div>
</section>

<section class="slide cover picture">
    <div>
        <h2>CORS</h2>
        <img src="pictures/cors.jpg" alt="" width="1024px" height="640px">
        <style>
            .picture h2
            {
                color: #FFF;
            }
        </style>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Что хочется?</h2>
        <ol>
            <li>post, option, put, delete ...</li>
            <li>ходить с разных доменов</li>
            <li>куки</li>
            <li>писать мало кода</li>
        </ol>
    </div>
</section>

<section class="slide">
    <div>
        <h2>CORS - cross-origin resource sharing</h2>

        <div>Стандарт http://www.w3.org/TR/cors/</div>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Как реализованно в браузере?</h2>

        <div>XMLHttpRequest -> XMLHttpRequest2</div>
    </div>
</section>

<section class="slide cover picture" style="background: white">
    <div>
        <img src="pictures/cors-scheme.jpg" alt="" width="1024px" height="640px">
    </div>
</section>

<section class="slide">
    <div>
        <h2>Примерчики</h2>
    </div>
</section>

<section class="slide cover picture">
    <div>
        <img src="pictures/cats.jpg" alt="" width="1024px" height="640px">
    </div>
</section>

<section class="slide">
    <div>
        <h2>Кототопология</h2>
        <ul>
            <li>api.sanchozfood.com</li>
            <li>touch.sanchozfood.com</li>
            <li>mobile.sanchozfood.com</li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <h2 style="color:#ff4816">Фликс и Фокс: первый шаг</h2>
        <pre class="code_size_small">
            <code>var url = 'http://api.sanchozfood.com/foods/fish</code>
            <code>var xhr = new XMLHttpRequest();</code>
            <code>xhr.open('GET', url, true);</code>
            <code>&nbsp;</code>
            <code>xhr.onload = function() {</code>
            <code> var text = xhr.responseText;</code>
            <code> showFood(text);</code>
            <code>};</code>
            <code>&nbsp;</code>
            <code>xhr.onerror = function() {</code>
            <code> alert('Санчоз набажил');</code>
            <code>};</code>
            <code>&nbsp;</code>
            <code>xhr.send();</code>
        </pre>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Заголовочки</h2>
        <pre class="code_size_small">
            <code>GET /cors HTTP/1.1</code>
            <code>Origin: http://mobile.sanchozfood.com</code>
            <code>Host: api.sanchozfood.com</code>
            <code>Accept-Language: en-US</code>
            <code>Connection: keep-alive</code>
            <code>User-Agent: Mozilla/5.0...</code>
        </pre>
    </div>
</section>

<section class="slide">
    <div>
        <h2>It doesn't work</h2>

        <div style="color: red">
            <p>
                XMLHttpRequest cannot load https://api.sanchozfood.com/.
                No <b>'Access-Control-Allow-Origin' header</b> is present on the requested resource.
                Origin 'https://mobile.sanchozfood.com' is therefore not allowed access.
            </p>
        </div>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Санчоз: первый фикс</h2>
        Было
        <pre class="code_size_small">
            <code>Content-Type: text/html; charset=utf-8</code>
            <code>...</code>
        </pre>
        Стало
        <pre class="code_size_small">
            <code>Access-Control-Allow-Origin: http://mobile.sanchozfood.com</code>
            <code>Content-Type: text/html; charset=utf-8</code>
        </pre>
    </div>
</section>

<section class="slide">
    <div>
        <h2 style="color:#ff4816">Фликс и Фокс: i'm watching you</h2>
        <pre class="code_size_small">
            <code>var url = 'http://api.sanchozfood.com/favourites/fish</code>
            <code>var xhr = new XMLHttpRequest();</code>
            <code>xhr.open('GET', url, true);</code>
            <code>&nbsp;</code>
            <code>xhr.onload = function() {</code>
            <code> var text = xhr.responseText;</code>
            <code> showFood(text);</code>
            <code>};</code>
            <code>&nbsp;</code>
            <code>xhr.send();</code>
        </pre>
    </div>
</section>

<section class="slide">
    <div>
        <h2>It doesn't work</h2>

        <div>
            Печенки не отправились на сервер
        </div>
    </div>
</section>

<section class="slide">
    <div>
        <h2 style="color:#ff4816">Фликс и Фокс: i'm watching you now</h2>
        <pre class="code_size_small">
            <code>var url = 'http://api.sanchozfood.com/favourites/fish</code>
            <code>var xhr = new XMLHttpRequest();</code>
            <code>xhr.open('GET', url, true);</code>
            <code>&nbsp;</code>
            <code>xhr.onload = function() {</code>
            <code> var text = xhr.responseText;</code>
            <code> showFood(text);</code>
            <code>};</code>
            <code>&nbsp;</code>
            <code style="font-weight: 700">xhr.withCredentials = true;</code>
            <code>&nbsp;</code>
            <code>xhr.send();</code>
        </pre>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Куда делись печенки от сервера?</h2>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Санчоз: в погоне за печенкой</h2>
        Было
        <pre class="code_size_small">
            <code>Access-Control-Allow-Origin: http://mobile.sanchozfood.com</code>
            <code>Content-Type: text/html; charset=utf-8</code>
            <code>...</code>
        </pre>
        Стало
        <pre class="code_size_small">
            <code>Access-Control-Allow-Origin: http://mobile.sanchozfood.com</code>
            <code>Access-Control-Allow-Credentials: true</code>
            <code>Content-Type: text/html; charset=utf-8</code>
        </pre>
    </div>
</section>

<section class="slide">
    <div>
        <h2 style="color:#ff4816">Фликс и Фокс: покупки</h2>
        <pre class="code_size_small">
            <code>var url = 'http://api.sanchozfood.com/order/F27D3178-2D41-4253-ABF3-9685F85FA298</code>
            <code>var xhr = new XMLHttpRequest();</code>
            <code>xhr.open('POST', url, true);</code>
            <code>&nbsp;</code>
            <code>xhr.onload = function() {</code>
            <code> var text = xhr.responseText;</code>
            <code> onMakeOrder(text);</code>
            <code>};</code>
            <code>&nbsp;</code>
            <code>xhr.withCredentials = true;</code>
            <code>&nbsp;</code>
            <code>xhr.send();</code>
        </pre>
    </div>
</section>

<section class="slide">
    <div>
        <h2>И тут пришел рефакторинг...</h2>
    </div>
</section>

<section class="slide cover picture" style="background: white">
    <div>
        <img src="pictures/cors-scheme.jpg" alt="" width="1024px" height="640px">
    </div>
</section>

<section class="slide">
    <div style=>
        <h2>Немного о "нормальных" кросс-доменных запросах</h2>

        <div style="float: left">Http-Method
            <ul style="line-height: 1.3">
                <li>Head</li>
                <li>Get</li>
                <li>Post</li>
            </ul>
        </div>

        <div style="float: right;">Http-HEADERS
            <ul style="line-height: 1.3">
                <li>Accept</li>
                <li>Accept-Language</li>
                <li>Content-Language</li>
                <li>Last-Event-ID</li>
                <li>
                    Content-Type, but only if the value is one of:
                    <ul>
                        <li>application/x-www-form-urlencoded</li>
                        <li>multipart/form-data</li>
                        <li>text/plain</li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</section>

<section class="slide cover picture">
    <div>
        <img src="pictures/tamozhnya.jpg" alt="" width="1024px" height="640px">
    </div>
</section>

<section class="slide">
    <div>
        <h2 style="color:#ff4816">Фликс и Фокс: подтверждение телефона</h2>
        <pre class="code_size_small">
            <code>var url = 'http://api.sanchozfood.com/confirm/phone</code>
            <code>var xhr = new XMLHttpRequest();</code>
            <code>xhr.open('POST', url, true);</code>
            <code style="font-weight: 700">xml.setRequestHeader('SMS-CODE', '2015');</code>
            <code style="font-weight: 700">xml.setRequestHeader('CONTENT-TYPE', 'application/json');</code>
            <code>&nbsp;</code>
            <code>xhr.onload = function() {</code>
            <code> var text = xhr.responseText;</code>
            <code> onMakeOrder(text);</code>
            <code>};</code>
            <code>&nbsp;</code>
            <code>xhr.withCredentials = true;</code>
            <code>&nbsp;</code>
            <code>xhr.send();</code>
        </pre>
    </div>
</section>

<section class="slide">
    <div>
        <h2>It doesn't work</h2>
        Санчоз забыл реализовать метод OPTIONS!
    </div>
</section>

<section class="slide">
    <div>
        <h2>Санчоз: очередные заголовки, но для preflight</h2>
        <pre class="code_size_small">
            <code>OPTIONS /confirm/phone HTTP/1.1</code>
            <code>Access-Control-Allow-Origin: http://mobile.sanchozfood.com</code>
            <code>Access-Control-Allow-Methods: GET, POST, PUT</code>
            <code>Access-Control-Allow-Headers: SMS-CODE</code>
            <code>Access-Control-Allow-Credentials: true</code>
            <code>Access-Control-Max-Age: 60</code>
        </pre>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Распространненные баги...</h2>
        <ul>
            <li>Нужно добавить поддержку OPTIONS</li>
            <li>Access-Control-Allow-Origin: *</li>
            <li>Preflight request не шлет куки!</li>
            <li>Ответы с ошибками должны тоже позаботиться о кросс-доменности</li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Немного о jquery</h2>
        <pre class="code_size_small">
            <code>$.ajax({</code>
            <code> type: 'GET',</code>
            <code> url: 'http://sanchozfood.com/favourite/fish',</code>
            <code> contentType: 'text/plain',</code>
            <code>&nbsp;</code>
            <code> xhrFields: {</code>
            <code> withCredentials: false</code>
            <code> },</code>
            <code>&nbsp;</code>
            <code> headers: {}</code>
            <code>});</code>
        </pre>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Can i use cors?</h2>
    </div>
</section>

<section class="slide">
    <div>
        <h2>IE свой путь</h2>
        XDomainRequest
        <ul style="font-size: 17px">
            <li>The target URL must be accessed using the HTTP or HTTPS protocols.</li>
            <li>The target URL must be accessed using only the HTTP methods GET and POST</li>
            <li>No custom headers may be added to the request</li>
            <li>Only text/plain is supported for the request's Content-Type header</li>
            <li>No authentication or cookies will be sent with the request</li>
            <li>Requests targeted to Intranet URLs may only be made from the Intranet Zone</li>
            <li>Requests must be targeted to the same scheme as the hosting page</li>
        </ul>
    </div>
</section>

<section class="slide cover picture">
    <div>
        <img src="pictures/all-is-bad.jpg" alt="" width="1024px" height="640px">
    </div>
</section>

<section class="slide">
    <div>
        <h2>Решение от диагностики</h2>
        <ul style="font-size: 17px">
            <li>Добавляем наш сайт в доверенные сайты</li>
            <li>Разешаем кросс-доменные запросы</li>
            <li>Profit</li>
        </ul>
    </div>
</section>

<section class="slide cover picture">
    <div>
        <img src="pictures/ie8-same-origin-policy.png" alt="" width="1024px" height="640px">
    </div>
</section>

<section class="slide">
    <div>
        <h2>Проклятый Jquery</h2>
        <pre class="code_size_small">
            <code>$.support.cors = true;</code>
        </pre>
    </div>
</section>


<section class="slide">
    <div>
        <h2>Ссылки</h2>
        <ul>
            <li><a href="http://www.html5rocks.com/en/tutorials/cors/">Статья о CORS</a></li>
            <li>
                <a href="http://blogs.msdn.com/b/ieinternals/archive/2010/05/13/xdomainrequest-restrictions-limitations-and-workarounds.aspx">Статья
                    о XDomainObject</a></li>
            <li><a href="http://www.w3.org/TR/cors/">Стандарт</a></li>
        </ul>
    </div>
</section>

<section class="slide">
    <div>
        <h2>Вопросы?</h2>
    </div>
</section>


<div class="progress">
    <div></div>
</div>
<script src="node_modules/shower-core/shower.min.js"></script>
<!-- Copyright © 2014 Yours Truly, Famous Inc. -->
<!-- Photos by John Carey, fiftyfootshadows.net -->
</body>
</html>